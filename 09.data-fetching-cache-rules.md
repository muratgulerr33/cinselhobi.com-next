# 09. Data Fetching & Cache Rules

Bu doküman, Cinselhobi.com Next projesinin veri getirme, cache/ISR, client vs server fetch, mutation/optimistic UI ve invalidation kurallarını tanımlar. Amaç: AI asistanların (Cursor/Gemini) yanlış cache, yanlış fetch yeri ve gereksiz client state üretmesini engellemek ve tutarlı veri yönetimi sağlamak.

**Last verified from package.json:** 2025-01-27  
**Proje:** cinselhobi-com-next  
**Next.js:** 16.1.1  
**React:** 19.2.3

**Evidence:** `package.json` (dependencies: next@16.1.1, react@19.2.3, react-dom@19.2.3)

---

## 1. Purpose

Bu doküman şu konuları kilitler:

1. **Doğru fetch yeri:** Server Component vs Client Component kararları, ne zaman nerede fetch yapılacağı
2. **Doğru cache stratejisi:** API route cache ayarları, revalidation pattern'leri, ISR kullanımı
3. **Doğru invalidation:** Mutation sonrası cache invalidation (revalidatePath/revalidateTag)
4. **Optimistic UI pattern'leri:** Client-side optimistic update + server sync + rollback
5. **localStorage hydration:** Client state'in server'dan hydrate edilmesi (cart, favorites, search)
6. **Error handling & retry:** Network error'lar, retry stratejileri, edge case'ler

**Evidence:** Bu doküman, repo'daki mevcut pattern'leri analiz ederek oluşturulmuştur.

---

## 2. Current Data Sources (Observed)

### 2.1 Database (PostgreSQL via Drizzle ORM)
- **Server Components:** Direct DB queries (`src/db/queries/` fonksiyonları)
- **API Routes:** Direct DB queries (`db` instance kullanımı)
- **Server Actions:** Direct DB queries (mutations için)

**Evidence:** `src/app/page.tsx` (lines 11-14: `getTopCategories`, `getLatestProductsCursor`), `src/app/api/search/route.ts` (lines 27-36: direct DB queries), `src/actions/checkout.ts` (line 4: `createOrder` query)

### 2.2 API Routes (Internal)
- `/api/products`: Cursor-based pagination, filtreleme
- `/api/products/[slug]`: Ürün detay
- `/api/products/[slug]/related`: İlgili ürünler
- `/api/search`: Arama (ürün + kategori)

**Evidence:** `src/app/api/products/route.ts`, `src/app/api/products/[slug]/route.ts`, `src/app/api/search/route.ts`

### 2.3 Server Actions
- `src/actions/checkout.ts`: Sipariş oluşturma
- `src/actions/address.ts`: Adres CRUD
- `src/actions/favorites.ts`: Favori toggle/list
- `src/actions/admin.ts`: Admin mutations (sipariş durumu güncelleme)

**Evidence:** `src/actions/checkout.ts` (line 1: `"use server"`), `src/actions/favorites.ts` (line 1: `"use server"`)

### 2.4 localStorage
- **Cart:** `CART_STORAGE_KEY` ile sepet state'i persist edilir
- **Search:** `RECENT_SEARCHES_KEY` ile son aramalar saklanır
- **Tab scroll:** `sessionStorage` ile scroll position kaydedilir

**Evidence:** `src/components/cart/cart-store.ts` (line 16: `localStorage.getItem(CART_STORAGE_KEY)`), `src/components/search/search-overlay.tsx` (line 43: `localStorage.getItem(RECENT_SEARCHES_KEY)`), `src/components/app/tab-scroll.ts` (line 17: `sessionStorage.setItem`)

### 2.5 Session/Auth Data
- **NextAuth.js:** `auth()` helper ile session bilgisi
- **Client-side:** `useSession()` hook (next-auth/react)

**Evidence:** `package.json` (dependencies: next-auth@5.0.0-beta.25), `src/app/page.tsx` (line 8: `await auth()`), `src/components/favorites/favorites-provider.tsx` (line 18: `useSession()`)

---

## 3. Fetch Decision Tree (RSC vs Client)

### 3.1 Default: Server Components (RSC)
**Kural:** Varsayılan olarak Server Component'te fetch yapılır. SEO, performans ve initial load için tercih edilir.

**Kullanım Alanları:**
- Initial page data (kategoriler, ürün listesi, ürün detay)
- SEO-critical content (metadata, product details)
- Auth-required data (user-specific initial data)

**Pattern:**
```typescript
// Server Component (page.tsx)
export default async function Page() {
  const data = await getDataFromDB(); // Direct DB query
  return <ClientComponent initialData={data} />;
}
```

**Evidence:** `src/app/page.tsx` (lines 7-14: async Server Component, direct DB queries), `src/app/urun/[slug]/page.tsx` (line 72: async Server Component, `getProductBySlug`)

### 3.2 Client Fetch: Sadece Gerekli Durumlarda
**Kural:** Client Component'te fetch sadece şu durumlarda yapılır:
- **Interaktif/polling:** Real-time data, infinite scroll pagination
- **User-triggered:** Search overlay, filter changes
- **Optimistic UI:** Mutation sonrası immediate feedback

**Kullanım Alanları:**
- Infinite scroll pagination (`LoadMoreGrid`)
- Real-time search (`SearchOverlay`)
- Product detail fetch (Client Component içinde, AbortController ile)

**Pattern:**
```typescript
// Client Component
"use client";
useEffect(() => {
  fetch("/api/products").then(...);
}, [dependencies]);
```

**Evidence:** `src/components/catalog/load-more-grid.tsx` (lines 46-111: `useEffect` + `fetch`), `src/components/search/search-overlay.tsx` (lines 130-174: debounced search fetch), `src/components/product/product-detail-page.tsx` (lines 70-124: `useEffect` + `fetch` with AbortController)

### 3.3 Provider State (localStorage Hydration)
**Kural:** Cart, Favorites, Search gibi client state'ler:
1. Server'dan initial data alınır (auth varsa)
2. localStorage'dan hydrate edilir (client-side)
3. `hydrated` flag ile SSR/client mismatch önlenir

**Pattern:**
```typescript
// Provider
const [state, setState] = useState(initial);
const [hydrated, setHydrated] = useState(false);

useEffect(() => {
  setState(loadFromLocalStorage());
  setHydrated(true);
}, []);
```

**Evidence:** `src/components/cart/cart-provider.tsx` (lines 24-35: localStorage hydration), `src/components/favorites/favorites-provider.tsx` (lines 22-35: server fetch + hydration)

---

## 4. Server Data Fetching Rules

### 4.1 Direct DB Queries (Default)
**Kural:** Server Component'lerde varsayılan olarak Drizzle ORM ile direkt veritabanı sorguları yapılır. `fetch()` API'si kullanılmaz. İstisna durumlar için onay gerekir.

**Pattern:**
```typescript
import { getTopCategories } from "@/db/queries/catalog";

export default async function Page() {
  const categories = await getTopCategories(8);
  return <CategoryGrid categories={categories} />;
}
```

**Evidence:** `src/app/page.tsx` (lines 11-14: `getTopCategories`, `getLatestProductsCursor`), `src/app/[slug]/page.tsx` (lines 47-136: `getCategoryBySlug`, `getProductsCursor`)

### 4.2 Query Functions Location
**Kural:** Tüm query fonksiyonları `src/db/queries/` altında organize edilir.

**Evidence:** `src/db/queries/catalog.ts`, `src/db/queries/favorites.ts`, `src/db/queries/address.ts`, `src/db/queries/order.ts`

### 4.3 Auth Context in Server Components
**Kural:** Server Component'lerde `auth()` helper ile session bilgisi alınır, userId query'lere geçirilir.

**Pattern:**
```typescript
const session = await auth();
const userId = session?.user?.id ?? null;
const data = await getData({ userId });
```

**Evidence:** `src/app/page.tsx` (lines 8-9, 14: `auth()` + `userId`), `src/app/api/products/route.ts` (lines 13-14: `auth()` + `userId`)

### 4.4 Server Component Cache
**Kural:** Server Component'lerde explicit cache ayarı yok. Next.js default caching kullanılır.

**Evidence:** `src/app/page.tsx` (no `revalidate` or `dynamic` export), `src/app/urun/[slug]/page.tsx` (no cache config)

---

## 5. Client Data Fetching Rules

### 5.1 Fetch API (Native)
**Kural:** Client Component'lerde native `fetch` API kullanılır. Axios, got gibi HTTP client library'leri kullanılmaz.

**Pattern:**
```typescript
const response = await fetch("/api/products");
const data = await response.json();
```

**Evidence:** `src/components/catalog/load-more-grid.tsx` (line 78: `fetch(url.toString())`), `src/components/search/search-overlay.tsx` (line 144: `fetch(\`/api/search?q=...\`)`)

### 5.2 AbortController Pattern
**Kural:** Client Component'lerde hızlı değişen dependency'ler veya unmount riski olan fetch'lerde AbortController ile request'ler cancel edilebilir olmalı (component unmount, dependency change).

**Pattern:**
```typescript
const abortControllerRef = useRef<AbortController | null>(null);

useEffect(() => {
  if (abortControllerRef.current) {
    abortControllerRef.current.abort();
  }
  abortControllerRef.current = new AbortController();
  
  fetch(url, { signal: abortControllerRef.current.signal })
    .then(...)
    .catch(err => {
      if (err.name === "AbortError") return;
      // handle error
    });
    
  return () => {
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
    }
  };
}, [dependencies]);
```

**Evidence:** `src/components/product/product-detail-page.tsx` (lines 61, 76-120: AbortController pattern)

### 5.3 Error Handling
**Kural:** Client fetch'lerde try-catch ile error handling yapılır, error state yönetilir.

**Pattern:**
```typescript
const [error, setError] = useState<string | null>(null);

try {
  const res = await fetch(url);
  if (!res.ok) throw new Error("...");
  const data = await res.json();
  setData(data);
} catch (err) {
  setError(err instanceof Error ? err.message : "Bir hata oluştu");
}
```

**Evidence:** `src/components/catalog/load-more-grid.tsx` (lines 44, 79-81, 107: error state), `src/components/product/product-detail-page.tsx` (lines 59, 106-113: error handling)

### 5.4 Data Fetching Libraries
**Kural:** React Query, SWR, Zustand gibi data fetching library'leri kullanılmaz. Native fetch + Context API kullanılır.

**Evidence:** `package.json` (no react-query, swr, zustand dependencies), `src/components/catalog/load-more-grid.tsx` (native fetch)

---

## 6. Caching & Revalidation Strategy

### 6.1 API Route Cache Settings
**Kural:** Bazı API route handler'lar açıkça `dynamic = "force-dynamic"` ve/veya `revalidate = 0` set eder ve `Cache-Control: no-store` kullanır (örn. products route'ları). Diğerleri Next.js default'larına güvenebilir.

**Observed API Route Cache Configurations:**

| Endpoint | File | dynamic export? | revalidate export? | Cache-Control set? |
|----------|------|----------------|-------------------|-------------------|
| `/api/products` | `src/app/api/products/route.ts` | Yes (`force-dynamic`) | Yes (`0`) | Yes (`no-store`) |
| `/api/products/[slug]` | `src/app/api/products/[slug]/route.ts` | Yes (`force-dynamic`) | No | No |
| `/api/products/[slug]/related` | `src/app/api/products/[slug]/related/route.ts` | Yes (`force-dynamic`) | No | No |
| `/api/search` | `src/app/api/search/route.ts` | No | No | No |

**Evidence:** `src/app/api/products/route.ts` (lines 9-10, 148: `dynamic`, `revalidate`, `Cache-Control`), `src/app/api/products/[slug]/route.ts` (line 4: `dynamic`), `src/app/api/products/[slug]/related/route.ts` (line 4: `dynamic`), `src/app/api/search/route.ts` (no cache config exports)

### 6.2 Page-Level Cache
**Kural:** Page-level cache ayarları:
- `src/app/about/page.tsx`: `export const dynamic = "force-dynamic"`
- `src/app/account/wishlist/page.tsx`: `export const dynamic = "force-dynamic"`
- `src/app/not-found.tsx`: `export const dynamic = "force-dynamic"`

**Evidence:** `src/app/about/page.tsx` (line 3: `dynamic`), `src/app/account/wishlist/page.tsx` (line 6: `dynamic`)

### 6.3 Data Freshness Requirements
**Katalog/Listing:**
- **Freshness:** Real-time (force-dynamic, no-store)
- **Reason:** Fiyat, stok durumu, yeni ürünler anlık güncellenmeli

**Product Detail:**
- **Freshness:** Real-time (force-dynamic)
- **Reason:** Fiyat, stok, görseller güncel olmalı

**Cart:**
- **Freshness:** Client-side (localStorage), server sync yok
- **Reason:** Sepet client state, server'da persist edilmiyor

**Account (Auth):**
- **Freshness:** Session-based (NextAuth.js)
- **Reason:** Auth state session cookie ile yönetiliyor

**Evidence:** `src/app/api/products/route.ts` (force-dynamic, no-store), `src/components/cart/cart-provider.tsx` (localStorage only)

### 6.4 Cache Invalidation (revalidatePath)
**Kural:** Server Action'larda mutation sonrası `revalidatePath` ile ilgili sayfaların cache'i invalidate edilir.

**Pattern:**
```typescript
import { revalidatePath } from "next/cache";

export async function toggleFavoriteAction(productId: number) {
  // ... mutation
  revalidatePath("/", "layout");
  revalidatePath("/account/wishlist");
  revalidatePath("/urun/[slug]", "page");
}
```

**Evidence:** `src/actions/favorites.ts` (lines 4, 30-32: `revalidatePath`), `src/actions/admin.ts` (lines 7, 58-59: `revalidatePath`)

### 6.5 Cache Tags (revalidateTag)
**Kural:** `revalidateTag` kullanılmıyor. Sadece `revalidatePath` kullanılıyor.

**Evidence:** Codebase search (no `revalidateTag` usage found)

---

## 7. ISR / Revalidate Rules

### 7.1 ISR Usage
**Kural:** Tarama tarihi itibariyle (2025-01-27), page-level ISR export'ları tespit edilmedi. Tüm sayfalar force-dynamic veya default (dynamic) rendering kullanıyor.

**Evidence:** Codebase search (no `revalidate` export in page.tsx files except API routes)

### 7.2 Trade-off Notes
**Reasoning:** E-ticaret sitesi olduğu için:
- Fiyat, stok durumu anlık güncellenmeli (ISR uygun değil)
- Ürün listesi sık değişiyor (ISR cache hit rate düşük olur)
- User-specific data (favorites, cart) var (ISR ile uyumsuz)

**Evidence:** `src/app/api/products/route.ts` (force-dynamic), `src/app/page.tsx` (no ISR config)

---

## 8. Mutations & Optimistic UI

### 8.1 Server Actions Pattern
**Kural:** Tüm mutations Server Action olarak `src/actions/` altında tanımlanır. `"use server"` direktifi zorunlu.

**Pattern:**
```typescript
"use server";

export async function createOrderAction(data: z.infer<typeof schema>) {
  const session = await auth();
  if (!session?.user?.id) {
    return { ok: false, error: "Unauthorized" };
  }
  // ... validation, mutation
  return { ok: true, orderId: order.id };
}
```

**Evidence:** `src/actions/checkout.ts` (line 1: `"use server"`), `src/actions/address.ts` (line 1: `"use server"`), `src/actions/favorites.ts` (line 1: `"use server"`)

### 8.2 Optimistic UI (Favorites)
**Kural:** Favorites toggle'da optimistic update yapılır:
1. Client state hemen güncellenir (optimistic)
2. Server Action çağrılır
3. Hata durumunda rollback yapılır
4. Başarı durumunda server'dan gelen final state set edilir

**Pattern:**
```typescript
// Optimistic update
setFavoriteIds((prev) => {
  const next = new Set(prev);
  next.add(productId); // or delete
  return next;
});

// Server action
const result = await toggleFavoriteAction(productId);

if (!result.ok) {
  // Rollback
  setFavoriteIds((prev) => {
    const next = new Set(prev);
    // revert change
    return next;
  });
} else {
  // Final state from server
  setFavoriteIds((prev) => {
    const next = new Set(prev);
    if (result.isFavorite) next.add(productId);
    else next.delete(productId);
    return next;
  });
}
```

**Evidence:** `src/components/favorites/favorites-provider.tsx` (lines 52-99: optimistic update + rollback + final state)

### 8.3 Optimistic UI (Cart)
**Kural:** Cart'ta optimistic update yok. Client state direkt güncellenir (localStorage sync).

**Evidence:** `src/components/cart/cart-provider.tsx` (lines 48-57: direct state update, no server sync)

### 8.4 Feedback (Toast)
**Kural:** Mutation sonrası feedback Sonner toast ile gösterilir.

**Pattern:**
```typescript
import { toast } from "sonner";

toast.success("Ürün sepete eklendi");
```

**Evidence:** `src/components/product/product-view.tsx` (line 81: `toast.success`), `src/app/layout.tsx` (line 82: `<Toaster>`)

---

## 9. Error Handling, Retries, and Edge Cases

### 9.1 API Route Error Handling
**Kural:** API route'larda try-catch ile error handling yapılır, JSON error response döner.

**Pattern:**
```typescript
try {
  // ... logic
  return NextResponse.json({ data });
} catch (error) {
  console.error("Error:", error);
  return NextResponse.json({ error: "..." }, { status: 500 });
}
```

**Evidence:** `src/app/api/search/route.ts` (lines 25-106: try-catch), `src/app/api/products/[slug]/route.ts` (lines 46, 52: error responses)

### 9.2 Client Error Handling
**Kural:** Client Component'lerde error state yönetilir, kullanıcıya toast veya inline error gösterilir.

**Evidence:** `src/components/catalog/load-more-grid.tsx` (lines 44, 79-81: error state), `src/components/product/product-detail-page.tsx` (lines 59, 106-113: error handling)

### 9.3 Retry Strategy
**Kural:** Client-side retry pattern'i yok. Network error durumunda kullanıcı manuel retry yapmalı.

**Evidence:** `src/components/catalog/load-more-grid.tsx` (no retry logic), `src/components/search/search-overlay.tsx` (no retry logic)

### 9.4 Edge Cases
**Stock/Price Changes:**
- **Unknown:** Stock veya fiyat değişimi durumunda client-side validation yapılıyor mu bilinmiyor.

**AbortController Edge Cases:**
- Component unmount durumunda fetch cancel edilir (AbortController)
- Dependency change durumunda önceki request cancel edilir

**Evidence:** `src/components/product/product-detail-page.tsx` (lines 76-120: AbortController cleanup), `src/components/catalog/load-more-grid.tsx` (no stock/price validation)

---

## 10. Auth / Session Data Handling

### 10.1 Server-Side Auth
**Kural:** Server Component'lerde ve Server Action'larda `auth()` helper ile session bilgisi alınır.

**Pattern:**
```typescript
import { auth } from "@/auth";

const session = await auth();
const userId = session?.user?.id ?? null;
```

**Evidence:** `src/app/page.tsx` (line 8: `await auth()`), `src/actions/checkout.ts` (line 21: `await auth()`)

### 10.2 Client-Side Auth
**Kural:** Client Component'lerde `useSession()` hook (next-auth/react) kullanılır.

**Pattern:**
```typescript
import { useSession } from "next-auth/react";

const { data: session } = useSession();
const userId = session?.user?.id;
```

**Evidence:** `src/components/favorites/favorites-provider.tsx` (line 18: `useSession()`)

### 10.3 Auth-Required Data Fetching
**Kural:** Auth-required data fetch'lerde:
- Server Component: `auth()` ile kontrol, userId query'ye geçirilir
- Client Component: `useSession()` ile kontrol, auth yoksa login'e yönlendirilir

**Evidence:** `src/app/api/products/route.ts` (lines 13-14: `auth()` + `userId`), `src/components/favorites/favorites-provider.tsx` (lines 44-50: auth check + redirect)

### 10.4 Middleware
**Kural:** Middleware kullanımı bilinmiyor (codebase'de middleware.ts bulunamadı).

**Evidence:** Codebase search (no `middleware.ts` found)

---

## 11. Performance Notes

### 11.1 Minimize Client Fetch
**Kural:** Gereksiz client fetch'lerden kaçınılır. Initial data Server Component'te getirilir, client sadece pagination/infinite scroll için fetch yapar.

**Evidence:** `src/app/page.tsx` (initial products Server Component'te), `src/components/catalog/load-more-grid.tsx` (sadece "Load More" için fetch)

### 11.2 Pagination Pattern
**Kural:** Büyük listelerde cursor-based pagination kullanılır. Infinite scroll pattern ile "Load More" butonu.

**Pattern:**
```typescript
// Server Component: Initial data
const initialProducts = await getLatestProductsCursor({ limit, userId });
const initialCursor = getNextCursor(initialProducts, limit);

// Client Component: Load more
const handleLoadMore = async () => {
  const res = await fetch(`/api/products?cursor=${cursor}&limit=${limit}`);
  const { products: newProducts, nextCursor } = await res.json();
  setProducts([...products, ...newProducts]);
  setCursor(nextCursor);
};
```

**Evidence:** `src/app/page.tsx` (lines 14-15: initial cursor), `src/components/catalog/load-more-grid.tsx` (lines 46-111: load more pattern)

### 11.3 Deduplication
**Kural:** Infinite scroll'da duplicate ürünler önlenir (wcId bazlı dedup).

**Evidence:** `src/components/catalog/load-more-grid.tsx` (lines 86-93: dedup logic)

### 11.4 Debouncing (Search)
**Kural:** Search overlay'de debouncing kullanılır (300ms).

**Evidence:** `src/components/search/search-overlay.tsx` (lines 130-174: debounced search, `DEBOUNCE_MS` constant)

---

## 12. Do / Don't

### 12.1 DO

1. **DO:** Listing verisini Server Component'te getir (initial data için)
   - **Evidence:** `src/app/page.tsx` (lines 11-14: Server Component fetch)

2. **DO:** Cart gibi client state'i provider'da tut (localStorage sync ile)
   - **Evidence:** `src/components/cart/cart-provider.tsx` (localStorage pattern)

3. **DO:** Infinite scroll için Client Component'te fetch yap (pagination)
   - **Evidence:** `src/components/catalog/load-more-grid.tsx` (load more fetch)

4. **DO:** Mutation sonrası `revalidatePath` ile cache'i invalidate et
   - **Evidence:** `src/actions/favorites.ts` (lines 30-32: `revalidatePath`)

5. **DO:** AbortController ile fetch request'leri cancel et (component unmount)
   - **Evidence:** `src/components/product/product-detail-page.tsx` (lines 76-120: AbortController)

6. **DO:** Optimistic UI için rollback pattern'i kullan (error durumunda)
   - **Evidence:** `src/components/favorites/favorites-provider.tsx` (lines 68-78: rollback)

7. **DO:** `hydrated` flag ile SSR/client mismatch önle (localStorage hydration)
   - **Evidence:** `src/components/cart/cart-provider.tsx` (line 25: `hydrated` flag)

8. **DO:** Server Action'larda Zod validation kullan
   - **Evidence:** `src/actions/checkout.ts` (lines 7-18: Zod schema)

9. **DO:** Real-time data gereken API route'larda `force-dynamic` + `no-store` kullan (örn. products route)
   - **Evidence:** `src/app/api/products/route.ts` (lines 9-10, 148: dynamic + no-store)

10. **DO:** Error handling için try-catch + error state kullan
    - **Evidence:** `src/app/api/search/route.ts` (lines 25-106: try-catch), `src/components/catalog/load-more-grid.tsx` (error state)

### 12.2 DON'T

1. **DON'T:** Her component'te ayrı fetch wrapper uydurma (native fetch kullan)
   - **Evidence:** `src/components/catalog/load-more-grid.tsx` (native fetch, no wrapper)

2. **DON'T:** Cache kurallarını bozacak `no-store`'u rastgele yayma (sadece real-time data gereken API route'larda)
   - **Evidence:** `src/app/api/products/route.ts` (no-store sadece products route'da), `src/app/api/search/route.ts` (no cache config)

3. **DON'T:** Server Component'te varsayılan olarak `fetch()` kullanma (direct DB query kullan; istisna durumlar için onay gerekir)
   - **Evidence:** `src/app/page.tsx` (direct DB queries, no fetch)

4. **DON'T:** Client Component'te initial data fetch yapma (Server Component'ten prop geç)
   - **Evidence:** `src/app/page.tsx` (initial data Server Component'te, `LoadMoreGrid` prop alıyor)

5. **DON'T:** React Query/SWR gibi data fetching library ekleme (native fetch + Context API)
   - **Evidence:** `package.json` (no react-query, swr dependencies)

6. **DON'T:** ISR kullanma (force-dynamic tercih et, real-time data için)
   - **Evidence:** `src/app/api/products/route.ts` (force-dynamic, no ISR)

7. **DON'T:** `revalidateTag` kullanma (sadece `revalidatePath` kullan)
   - **Evidence:** Codebase search (no `revalidateTag` usage)

8. **DON'T:** localStorage'ı Server Component'te kullanma (sadece Client Component)
   - **Evidence:** `src/components/cart/cart-provider.tsx` (Client Component, localStorage)

9. **DON'T:** Hızlı değişen dependency'ler veya unmount riski olan fetch'lerde AbortController olmadan fetch yapma (memory leak riski)
   - **Evidence:** `src/components/product/product-detail-page.tsx` (AbortController pattern)

10. **DON'T:** Optimistic update'te rollback yapmadan error handle etme
    - **Evidence:** `src/components/favorites/favorites-provider.tsx` (lines 68-78: rollback pattern)

---

## 13. Open Gaps

### 13.1 Cache Invalidation
- **Gap:** `revalidateTag` kullanılmıyor, sadece `revalidatePath` var. Tag-based invalidation daha granular olabilir.
- **Impact:** Tüm sayfa invalidate ediliyor, tag-based daha performanslı olabilir.

**Evidence:** Codebase search (no `revalidateTag` usage)

### 13.2 Error Retry Strategy
- **Gap:** Client-side retry pattern'i yok. Network error durumunda kullanıcı manuel retry yapmalı.
- **Impact:** Geçici network error'larında kullanıcı deneyimi kötü.

**Evidence:** `src/components/catalog/load-more-grid.tsx` (no retry logic)

### 13.3 Stock/Price Validation
- **Gap:** Sepete ekleme sırasında stock/price validation yapılıyor mu bilinmiyor.
- **Impact:** Stok bitmiş veya fiyat değişmiş ürün sepete eklenebilir.

**Evidence:** `src/components/product/product-view.tsx` (no stock/price validation in `handleAddToCart`)

### 13.4 Performance Budget
- **Gap:** Data fetching için performance budget yok (max response time, max payload size).
- **Impact:** Yavaş query'ler veya büyük payload'lar tespit edilemiyor.

**Evidence:** Unknown (no performance monitoring)

### 13.5 Request Deduplication
- **Gap:** Aynı anda aynı request'lerin duplicate edilmesi önlenmiyor (request deduplication yok).
- **Impact:** Gereksiz network request'leri, server load.

**Evidence:** `src/components/search/search-overlay.tsx` (no request deduplication)

### 13.6 Offline Support
- **Gap:** Offline durumunda data caching yok (Service Worker, Cache API).
- **Impact:** Offline durumunda uygulama çalışmıyor.

**Evidence:** Unknown (no Service Worker, no Cache API usage)

---

## 14. Evidence Index

1. **src/app/page.tsx** - Server Component, direct DB queries, initial data fetch (lines 7-14)
2. **src/app/urun/[slug]/page.tsx** - Server Component, product detail fetch (line 72)
3. **src/app/[slug]/page.tsx** - Server Component, category page, direct DB queries (lines 38-173)
4. **src/app/api/products/route.ts** - API route, force-dynamic, revalidate=0, no-store header (lines 9-10, 148)
5. **src/app/api/products/[slug]/route.ts** - API route, force-dynamic, product detail (line 4)
6. **src/app/api/search/route.ts** - API route, direct DB queries, try-catch error handling (lines 8-107)
7. **src/components/catalog/load-more-grid.tsx** - Client Component, fetch API, infinite scroll, error state (lines 46-111)
8. **src/components/search/search-overlay.tsx** - Client Component, debounced search fetch (lines 130-174)
9. **src/components/product/product-detail-page.tsx** - Client Component, fetch with AbortController (lines 70-124)
10. **src/components/cart/cart-provider.tsx** - Client Component, localStorage hydration, hydrated flag (lines 23-35)
11. **src/components/favorites/favorites-provider.tsx** - Client Component, server fetch + hydration, optimistic UI (lines 17-109)
12. **src/actions/checkout.ts** - Server Action, "use server", Zod validation (lines 1-49)
13. **src/actions/favorites.ts** - Server Action, revalidatePath, optimistic UI support (lines 1-40)
14. **src/actions/address.ts** - Server Action, address CRUD (lines 1-64)
15. **src/actions/admin.ts** - Server Action, revalidatePath (lines 1-71)
16. **src/components/cart/cart-store.ts** - localStorage cart persistence (lines 16, 41)
17. **src/components/search/search-overlay.tsx** - localStorage recent searches (line 43)
18. **src/components/app/tab-scroll.ts** - sessionStorage scroll position (line 17)
19. **src/components/product/product-view.tsx** - Toast feedback, add to cart (line 81)
20. **src/app/layout.tsx** - Toaster component, toast system (line 82)
21. **src/db/queries/catalog.ts** - Query functions, direct DB access
22. **src/db/queries/favorites.ts** - Favorites queries
23. **src/db/queries/address.ts** - Address queries
24. **src/db/queries/order.ts** - Order queries
25. **src/auth.ts** - NextAuth.js config, auth() helper
26. **package.json** - NextAuth.js version (next-auth@5.0.0-beta.25)
27. **package.json** - Dependencies (no react-query, swr, zustand)
28. **src/app/about/page.tsx** - Page-level dynamic config (line 3)
29. **src/app/account/wishlist/page.tsx** - Page-level dynamic config (line 6)
30. **src/app/not-found.tsx** - Page-level dynamic config (line 4)
31. **src/components/catalog/load-more-grid.tsx** - Deduplication logic (lines 86-93)
32. **src/app/api/products/[slug]/related/route.ts** - API route, force-dynamic (line 4)

---

**Not:** Bu doküman, repo'nun mevcut durumuna göre oluşturulmuştur. Yeni değişiklikler yapıldığında bu doküman güncellenmelidir.

