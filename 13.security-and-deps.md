şimdi # 13. Security and Dependencies

**As of repo scan: 2025-01-27**

## 1. Purpose

Bu doküman, cinselhobi.com-next projesi için frontend ve route handler güvenlik standartlarını ve dependency yönetim politikasını tanımlar. Aşağıdaki güvenlik alanlarını kapsar:

1. **XSS (Cross-Site Scripting) Koruması**: Kullanıcı girdilerinin sanitize edilmesi ve HTML render kuralları
2. **Authentication & Session Security**: Kullanıcı oturum yönetimi ve yetkilendirme
3. **Secrets Management**: Environment variable'ların güvenli kullanımı ve client'a sızma önleme
4. **Supply Chain Security**: Dependency güncelleme politikası ve vulnerability yönetimi
5. **Input Validation**: Server boundary'de validation ve output encoding
6. **API Security**: Route handler'larda auth check, rate limiting, error handling
7. **PII & Privacy**: Kişisel verilerin loglama ve analytics'te korunması
8. **Browser Security**: Security headers ve Content Security Policy (CSP)

---

## 2. Threat Model (Frontend Scope)

### Assets

Korunması gereken varlıklar:

- **User Session**: JWT token'ları ve session bilgileri
- **Order Data**: Sipariş detayları, ödeme bilgileri
- **Address Data**: Kullanıcı adres bilgileri (PII)
- **Favorites**: Kullanıcı favori ürün listesi
- **Admin Endpoints**: `/admin/*` route'ları ve admin-only actions
- **User Credentials**: Email ve password hash'leri (server-side)

**Evidence:** `src/app/account/layout.tsx` (protected routes), `src/app/admin/layout.tsx` (admin routes), `src/auth.ts` (session management)

### Attack Surface

Saldırı yüzeyleri:

- **Forms**: Login, signup, checkout, address forms (XSS, injection riski)
- **Search Parameters**: Query string'lerdeki user input (`/api/products`, `/api/search`)
- **Route Handlers**: `/api/*` endpoint'leri (auth bypass, rate limit bypass)
- **Server Actions**: `src/actions/*` (unauthorized access, validation bypass)
- **HTML Rendering**: `dangerouslySetInnerHTML` kullanımı (XSS riski)
- **3rd Party Scripts**: External image sources (Next.js Image component)

**Evidence:** `src/app/api/products/route.ts` (searchParams parsing), `src/components/product/product-view.tsx` (dangerouslySetInnerHTML), `src/actions/checkout.ts` (form validation)

### Admin Area

Admin area mevcut: `/admin/*` route'ları role-based access control ile korunuyor. Admin-only actions `src/actions/admin.ts` içinde tanımlı.

**Evidence:** `src/app/admin/layout.tsx` (role check: `session.user?.role !== "admin"`), `src/actions/admin.ts` (admin authorization check)

---

## 3. Secrets & Environment Variables

### Environment Files

Environment dosyaları repo'da görünmüyor (muhtemelen `.gitignore`'da). Beklenen dosyalar:

- `.env.local` (local development)
- `.env.production` (production, VPS'te olmalı)

**Evidence:** `.env*` dosyaları bulunamadı (as of repo scan: 2025-01-27)

### Environment Keys in Use

Kodda kullanılan environment key'leri:

- `AUTH_SECRET` - NextAuth secret (required)
- `DATABASE_URL` - PostgreSQL connection string
- `WOO_BASE_URL` - WooCommerce API base URL (import script)
- `WOO_CONSUMER_KEY` - WooCommerce API consumer key
- `WOO_CONSUMER_SECRET` - WooCommerce API consumer secret
- `WOO_IMPORT_MODE` - Import mode (`full` | `sample`)
- `WOO_IMPORT_LIMIT` - Sample mode limit
- `WOO_AUTH_MODE` - Auth mode (`basic` | `query`)
- `WOO_PRODUCT_STATUS` - Product status filter
- `NODE_ENV` - Environment mode (`development` | `production`)
- `TZ` - Timezone (`Europe/Istanbul`)

**Evidence:** `src/auth.ts` (AUTH_SECRET), `src/db/connection.ts` (DATABASE_URL), `scripts/woo-import.ts` (WOO_* keys), `next.config.ts` (TZ), `src/app/api/products/route.ts` (NODE_ENV)

### Rules

1. **Secret Leakage Prevention**: `NEXT_PUBLIC_*` prefix'i olmayan env key'ler client'a expose edilmez
2. **Server-Only Secrets**: `AUTH_SECRET`, `DATABASE_URL`, `WOO_CONSUMER_SECRET` gibi secret'lar sadece server-side kullanılır
3. **Client-Safe Keys**: `NEXT_PUBLIC_*` prefix'i olan key'ler client'a gönderilebilir (şu an kullanılmıyor)
4. **Production Validation**: Production'da `AUTH_SECRET` zorunludur (dev'de warning var)

**Evidence:** `src/auth.ts` (AUTH_SECRET check with console.warn), `src/db/connection.ts` (server-only DATABASE_URL)

---

## 4. Authentication & Session Security

### Authentication Method

**NextAuth v5 (Auth.js)** kullanılıyor. Credentials provider ile email/password authentication.

- **Provider**: `next-auth@5.0.0-beta.25`
- **Adapter**: `@auth/drizzle-adapter` (Drizzle ORM ile entegrasyon)
- **Password Hashing**: Argon2id (`argon2@0.44.0`)
- **Session Strategy**: JWT (database session değil)

**Evidence:** `package.json` (next-auth@5.0.0-beta.25, @auth/drizzle-adapter@1.11.1, argon2@0.44.0), `src/auth.ts` (NextAuth config, Credentials provider, argon2.verify), `src/auth.config.ts` (session strategy: "jwt")

### Protected Route Strategy

**Layout-level protection** kullanılıyor (middleware yok):

- `/account/*` - `src/app/account/layout.tsx` içinde `auth()` check, redirect `/login`
- `/admin/*` - `src/app/admin/layout.tsx` içinde `auth()` check + role check (`role !== "admin"`), redirect `/account` veya `/login`

**Evidence:** `src/app/account/layout.tsx` (session check, redirect), `src/app/admin/layout.tsx` (session + role check)

### Cookie Flags

NextAuth v5 default cookie flags kullanılıyor. Explicit configuration görülmedi.

**Assumption:** NextAuth v5 production'da `httpOnly`, `secure` (HTTPS'te), `sameSite: "lax"` kullanır.

**Reasoning:** NextAuth v5 default behavior. Explicit config yok, assumption.

**Evidence:** `src/auth.ts` (NextAuth config, cookie flags explicit değil), `src/auth.config.ts` (session config var ama cookie flags yok)

### CSRF Protection

**Unknown (as of repo scan: 2025-01-27)**

NextAuth v5 default olarak CSRF koruması sağlar, ancak explicit CSRF token check veya middleware'de CSRF validation görülmedi.

**Assumption:** NextAuth v5 built-in CSRF koruması aktif (default behavior).

**Reasoning:** NextAuth v5 documentation'a göre CSRF koruması default'ta var, ancak repo'da explicit kanıt yok.

**Evidence:** `src/auth.ts` (NextAuth config, CSRF explicit değil), middleware.ts yok

---

## 5. Input Validation & Output Encoding

### Validation Library

**Zod** kullanılıyor (`zod@4.2.1`). Server actions ve form validation'da kullanılıyor.

- Server actions: `src/actions/checkout.ts`, `src/actions/address.ts`
- Client forms: `src/components/account/address-form.tsx` (React Hook Form + Zod resolver)

**Evidence:** `package.json` (zod@4.2.1), `src/actions/checkout.ts` (checkoutSchema with zod), `src/actions/address.ts` (addressSchema with zod), `src/components/account/address-form.tsx` (zodResolver)

### Validation Rules

**Server boundary'de validate et; client-side sadece UX**

1. **Server Actions**: Tüm input'lar Zod schema ile validate edilir (`schema.parse(data)`)
2. **API Routes**: Search params manuel parse edilir (type coercion, clamp, whitelist)
3. **Client Forms**: React Hook Form + Zod resolver UX için kullanılır, ancak server action'da tekrar validate edilir
4. **Error Handling**: Zod validation error'ları user-friendly mesajlara çevrilir

**Evidence:** `src/actions/checkout.ts` (checkoutSchema.parse), `src/actions/address.ts` (addressSchema.parse), `src/app/api/products/route.ts` (searchParams manual parsing with validation)

### XSS Prevention

**Observed**: `dangerouslySetInnerHTML` kullanılıyor, ancak **sanitize edilmiş HTML** ile.

- **Sanitization Function**: `stripUnsafeHtml()` - `<script>`, `<style>` tag'lerini ve `on*` event handler'larını kaldırır
- **Usage**: `src/components/product/product-view.tsx` içinde product description render'ında kullanılıyor
- **Rule**: Sadece sanitize edilmiş HTML `dangerouslySetInnerHTML` ile render edilir

**Evidence:** `src/components/product/product-view.tsx` (stripUnsafeHtml function, dangerouslySetInnerHTML with safeDescriptionHtml)

---

## 6. API / Route Handler Security

### Authentication Checks

**Observed**: Bazı endpoint'lerde auth check var, bazılarında yok:

- `/api/products` - Optional auth (userId için favorites check, public endpoint)
- `/api/search` - Public endpoint (auth check yok)
- `/api/auth/signup` - Public endpoint (auth check yok)
- `/api/auth/[...nextauth]` - NextAuth handler (built-in auth)

**Protected endpoints**: Explicit protected API route yok. Protection layout seviyesinde (`/account/*`, `/admin/*`).

**Evidence:** `src/app/api/products/route.ts` (optional session check), `src/app/api/search/route.ts` (no auth check), `src/app/api/auth/signup/route.ts` (no auth check)

### Rate Limiting

**Not implemented (as of repo scan: 2025-01-27)**

API route'larında rate limiting yok. `/api/auth/signup` ve diğer public endpoint'ler rate limit koruması olmadan çalışıyor.

**Evidence:** Codebase search (rate limiting, ratelimit, throttle bulunamadı), `src/app/api/*/route.ts` (rate limit check yok)

### Error Handling

**Observed**: Error handling var, ancak stack trace sızdırma riski var:

- **API Routes**: `console.error` ile loglanıyor, user'a generic error mesajı dönülüyor
- **Server Actions**: Zod error'ları user-friendly mesajlara çevriliyor, internal error'lar generic mesajla dönülüyor
- **Risk**: `console.error` içinde full error object loglanıyor (production'da stack trace sızabilir)

**Evidence:** `src/app/api/search/route.ts` (console.error("Search error:", error), generic response), `src/actions/checkout.ts` (console.error with full error, generic user message)

### Logging & PII Masking

**Not implemented (as of repo scan: 2025-01-27)**

PII masking policy yok. `console.error` ve `console.log` içinde PII (email, address, phone) loglanabilir.

**Policy (recommended)**: 
- Email'ler maskelenmeli: `user@example.com` → `u***@example.com`
- Phone number'lar maskelenmeli: `+905551234567` → `+90***1234567`
- Address'ler loglanmamalı veya sadece city/district loglanmalı

**Evidence:** `src/app/api/auth/signup/route.ts` (console.error with potential PII), `src/actions/address.ts` (console.error with address data), `src/actions/favorites.ts` (console.log with user data)

---

## 7. Browser Security Headers & CSP

### Security Headers Configuration

**Not implemented (as of repo scan: 2025-01-27)**

`next.config.ts` veya `middleware.ts` içinde security headers set edilmiyor. Next.js default headers kullanılıyor.

**Evidence:** `next.config.ts` (sadece images config, headers yok), middleware.ts yok, `src/proxy.ts` (sadece NextResponse.next(), headers yok)

### Content Security Policy (CSP)

**Not implemented (as of repo scan: 2025-01-27)**

CSP header'ı set edilmiyor.

### Recommended Baseline (if not implemented)

**Assumption**: Production'da aşağıdaki headers set edilmeli:

- `X-Content-Type-Options: nosniff` - MIME type sniffing önleme
- `Referrer-Policy: strict-origin-when-cross-origin` - Referrer bilgisi kontrolü
- `Permissions-Policy: geolocation=(), microphone=(), camera=()` - Feature policy

**Content Security Policy (CSP) - Secure Baseline:**

If you must use inline scripts/styles, prefer `nonce-` or `sha256-` hashes. Avoid `unsafe-inline` and `unsafe-eval` in production.

Example secure CSP baseline (domain allowlist projeye göre güncellenecek):

```
default-src 'self';
base-uri 'self';
object-src 'none';
frame-ancestors 'none';
img-src 'self' data: https:;
font-src 'self' data: https:;
style-src 'self' 'nonce-<RANDOM_NONCE>' https:;
script-src 'self' 'nonce-<RANDOM_NONCE>' https:;
connect-src 'self' https:;
upgrade-insecure-requests;
```

**Note**: CSP must be validated against actual third-party integrations (analytics, payments, CDN).

**Reasoning**: Next.js default headers yeterli değil, explicit CSP ve security headers önerilir.

**Evidence:** `next.config.ts` (headers config yok), middleware.ts yok

---

## 8. File Uploads & Media

### Upload Implementation

**Not implemented (as of repo scan: 2025-01-27)**

File upload component veya route handler bulunamadı. `input type="file"` kullanımı yok.

**Evidence:** Codebase search (`type="file"`, `multipart`, `upload` bulunamadı)

### Validation & Limits

N/A (upload yok)

---

## 9. Dependency Policy (2026)

### Update Cadence

**Policy (recommended)**:

- **Patch updates**: Haftalık veya iki haftada bir (`npm update` veya `npm audit fix`)
- **Minor updates**: Aylık (planlı, test edilerek)
- **Major updates**: Karar kaydı (15) + kısa spike (dependency breaking changes değerlendirmesi)

**Evidence:** `package.json` (dependencies list, version ranges)

### Package Manager & Lockfile

**Observed**: **npm** kullanılıyor. `package-lock.json` mevcut.

- **Lockfile**: `package-lock.json` (git'te commit edilmeli)
- **Policy**: Tek package manager kullan (npm). `pnpm` veya `yarn` kullanılmamalı.

**Evidence:** `package-lock.json` (mevcut), `package.json` (npm scripts)

### Allowed Libraries

**Policy**: Mevcut stack dışına çıkmak approval ister:

- **Approval Required**: Yeni major dependency eklemeden önce karar kaydı (15) + spike
- **Stack**: Next.js 16, React 19, Drizzle ORM, NextAuth v5, Zod, Radix UI, Tailwind CSS
- **Exception**: Security patches ve minor updates approval gerektirmez

**Evidence:** `package.json` (current dependencies: next@16.1.1, react@19.2.3, drizzle-orm@0.45.1, next-auth@5.0.0-beta.25, zod@4.2.1)

---

## 10. Vulnerability Management (SCA)

### Security Audit Tools

**Not implemented (as of repo scan: 2025-01-27)**

`package.json` scripts'te `npm audit` veya başka security audit tool yok. GitHub Dependabot config yok.

**Evidence:** `package.json` (scripts: dev, build, start, lint, db:generate, db:migrate, woo:import - audit yok)

### Recommended Tools (if not implemented)

**Assumption**: Aşağıdaki tools önerilir:

- **npm audit**: `npm audit --production` (production dependencies için)
- **GitHub Dependabot**: Automated dependency updates ve security alerts
- **CI/CD Integration**: Pre-commit veya CI'da `npm audit` check

**Reasoning**: Dependency vulnerability management için automated tooling gerekli.

**Evidence:** `package.json` (audit script yok), `.github/dependabot.yml` yok

### Critical Vulnerability SLA

**Policy (recommended)**:

- **Critical (S0)**: 24 saat içinde patch veya workaround
- **High (S1)**: 7 gün içinde patch
- **Medium (S2)**: 30 gün içinde patch
- **Low (S3)**: Next minor update'te patch

**Evidence:** Policy (recommended, not implemented)

---

## 11. Logging, PII & Privacy

### PII Fields

PII sayılan alanlar:

- **Email**: Kullanıcı email adresi
- **Phone**: Telefon numarası (`src/actions/address.ts` içinde)
- **Address**: Tam adres bilgisi (`fullAddress`, `city`, `district`)
- **Name**: Kullanıcı adı
- **Order Notes**: Sipariş notları (varsa)

**Evidence:** `src/actions/address.ts` (addressSchema: phone, fullAddress, city, district), `src/auth.ts` (user email, name)

### Frontend Logging Rules

**Policy (recommended)**: PII console'a basılmaz.

**Observed**: `console.log` ve `console.error` içinde PII loglanıyor:

- `src/actions/favorites.ts`: `console.log("[toggleFavoriteAction] User ID:", userId)` - User ID PII değil ama loglanıyor
- `src/app/api/auth/signup/route.ts`: `console.error("Signup error:", error)` - Error içinde email olabilir

**Evidence:** `src/actions/favorites.ts` (console.log with user data), `src/app/api/auth/signup/route.ts` (console.error with potential PII)

### Analytics & PII

**Unknown (as of repo scan: 2025-01-27)**

Analytics tool (Google Analytics, Plausible, PostHog) bulunamadı. Analytics event'lerde PII yasağı policy olarak tanımlanmalı.

**Policy (recommended)**: Analytics event'lerde PII (email, phone, address) gönderilmez. Sadece anonymized user ID veya session ID kullanılır.

**Evidence:** Codebase search (analytics, ga, gtag, posthog, mixpanel bulunamadı)

---

## 12. Security Checklist (Do / Don't)

### DO

1. **DO**: Server boundary'de (server actions, API routes) tüm input'ları Zod ile validate et
2. **DO**: Protected sayfaları layout seviyesinde `auth()` check ile kilitle
3. **DO**: Admin-only actions'da role check yap (`session.user.role !== "admin"`)
4. **DO**: `dangerouslySetInnerHTML` kullanırken HTML'i sanitize et (`stripUnsafeHtml`)
5. **DO**: API error response'larında generic mesaj dön, internal detay sızdırma
6. **DO**: Environment variable'ları server-only kullan (`NEXT_PUBLIC_` prefix'i olmadan)
7. **DO**: Password'ları Argon2id ile hashle (argon2.verify kullan)
8. **DO**: Dependency update'lerde lockfile'ı güncelle (`package-lock.json`)
9. **DO**: Major dependency update'lerde karar kaydı (15) + spike yap
10. **DO**: Search params'ı manuel parse et ve validate et (type coercion, clamp, whitelist)
11. **DO**: Server actions'da Zod error'ları user-friendly mesajlara çevir
12. **DO**: Production'da `AUTH_SECRET` environment variable'ını set et
13. **DO**: Error log'larında PII mask'le (email, phone, address)
14. **DO**: `console.error` kullanırken stack trace'i production'da mask'le
15. **DO**: Dependency vulnerability'leri düzenli kontrol et (`npm audit`)

### DON'T

1. **DON'T**: `NEXT_PUBLIC_` prefix'i ile secret'ları client'a expose et
2. **DON'T**: User input'u sanitize etmeden `dangerouslySetInnerHTML` ile HTML bas
3. **DON'T**: API route'larda auth check yapmadan protected data döndür
4. **DON'T**: `console.log` veya `console.error` içinde PII (email, phone, address) logla
5. **DON'T**: Error response'larında stack trace veya internal error detayı sızdır
6. **DON'T**: Client-side validation'a güven, server-side validation zorunlu
7. **DON'T**: Rate limiting olmadan public API endpoint'leri expose et
8. **DON'T**: CSP ve security headers olmadan production'a deploy et
9. **DON'T**: Dependency update'lerde lockfile'ı ignore et
10. **DON'T**: Major dependency update'lerde test etmeden production'a deploy et

---

## 13. Open Gaps

Aşağıdaki security eksiklikleri repo taramasında bulunamadı (as of repo scan: 2025-01-27):

1. **Rate Limiting**: API route'larında rate limiting yok (`/api/auth/signup`, `/api/search` vb.)
2. **CSP (Content Security Policy)**: CSP header'ı set edilmiyor. CSP must be validated against actual third-party integrations (analytics, payments, CDN).
3. **Security Headers**: `X-Content-Type-Options`, `Referrer-Policy`, `Permissions-Policy` header'ları set edilmiyor
4. **Audit Pipeline**: `npm audit` CI/CD pipeline'ında yok, automated dependency updates yok
5. **Sentry/Monitoring**: Error tracking service (Sentry, LogRocket) yok
6. **Structured Logging**: `console.error` kullanılıyor, structured logging (Winston, Pino) yok
7. **PII Masking**: Log'larda PII masking policy yok
8. **Middleware**: `middleware.ts` yok, layout-level protection kullanılıyor (middleware daha güvenli)
9. **CSRF Explicit Check**: NextAuth default CSRF koruması var ama explicit check yok
10. **Analytics PII Policy**: Analytics tool yok, PII policy tanımlı değil

---

## 14. Evidence Index

1. `package.json` - Dependencies (next-auth@5.0.0-beta.25, zod@4.2.1, argon2@0.44.0)
2. `package-lock.json` - npm lockfile (package manager evidence)
3. `src/auth.ts` - NextAuth config, Credentials provider, Argon2 password verification
4. `src/auth.config.ts` - NextAuth config, JWT session strategy
5. `src/app/account/layout.tsx` - Protected route strategy (layout-level auth check)
6. `src/app/admin/layout.tsx` - Admin route protection (role check)
7. `src/actions/checkout.ts` - Zod validation, auth check, error handling
8. `src/actions/address.ts` - Zod validation, PII fields (phone, address), auth check
9. `src/actions/admin.ts` - Admin authorization check, role-based access
10. `src/app/api/products/route.ts` - Search params validation, optional auth check
11. `src/app/api/search/route.ts` - Public endpoint, no auth check, error handling
12. `src/app/api/auth/signup/route.ts` - Public endpoint, Argon2 password hashing, error logging
13. `src/components/product/product-view.tsx` - dangerouslySetInnerHTML with sanitization (stripUnsafeHtml)
14. `src/components/account/address-form.tsx` - React Hook Form + Zod resolver
15. `next.config.ts` - No security headers config, only images config
16. `src/db/connection.ts` - DATABASE_URL env key usage (server-only)
17. `scripts/woo-import.ts` - WOO_* env keys usage
18. `eslint.config.mjs` - ESLint config (no security plugin)
19. `src/proxy.ts` - Empty proxy, no middleware security
20. `src/actions/favorites.ts` - Console logging with user data (PII risk)
21. Codebase search - No rate limiting implementation found
22. Codebase search - No CSP/security headers implementation found
23. Codebase search - No analytics tool found (GA, Sentry, etc.)
24. Codebase search - No file upload implementation found
25. Codebase search - No npm audit script found
26. Codebase search - No middleware.ts found
27. Codebase search - No sanitize/DOMPurify library found (custom stripUnsafeHtml used)
28. `.env*` files - Not found in repo (likely in .gitignore)
